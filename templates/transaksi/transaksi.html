{% extends "base/base.html" %}
{% load static %}
{% load humanize %}

{% block title %} Transaksi {% endblock %}

{% block main %}
<div class="side-app">
	<div class="page-header">
		<div>
			<h1 class="page-title">Daftar Transaksi</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="#">Transaksi</a></li>
				<li class="breadcrumb-item active" aria-current="page">Daftar Transaksi</li>
			</ol>
		</div>
    <a href="#" data-bs-target="#modalTambahTransaksi" data-bs-toggle="modal" class="btn btn-success">Tambah Transaksi</a>
	</div>

	<div class="row row-sm">
		<div class="col-lg-12">
			<div class="card">
				<div class="card-header">
            <form method="get" class="d-flex flex-wrap align-items-center gap-2">
              <select name="filter_range" class="form-select form-select-">
                  <option value="">-- Pilih Filter --</option>
                  <option value="today" {% if request.GET.filter_range == "today" %}selected{% endif %}>Hari ini</option>
                  <option value="7days" {% if request.GET.filter_range == "7days" %}selected{% endif %}>7 Hari Terakhir</option>
                  <option value="1month" {% if request.GET.filter_range == "1month" %}selected{% endif %}>1 Bulan Terakhir</option>
              </select>

              <input type="date" name="start_date" class="form-control form-control"
                    value="{{ request.GET.start_date }}">
              <input type="date" name="end_date" class="form-control form-control"
                    value="{{ request.GET.end_date }}">


              <button type="submit" class="btn btn btn-primary">Filter</button>
              {% if filtered %}
                <a href="{% url 'app:export_transaksi' %}?filter_range={{ request.GET.filter_range }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}"
                  class="btn btn-success text-white">
                  <i class="fa fa-file-excel-o me-1"></i> Export ke Excel
                </a>
              {% else %}
                <a href="javascript:void(0);" 
                  class="btn btn-success text-white" 
                  onclick="showFilterAlert()">
                  <i class="fa fa-file-excel-o me-1"></i> Export ke Excel
                </a>
              {% endif %}
            </form>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-bordered text-nowrap border-bottom w-100" id="responsive-datatable">
							<thead>
								<tr>
									<th class="border-bottom-0">No</th>
									<th class="border-bottom-0">Jenis</th>
									<th class="border-bottom-0">Rekening Sumber</th>
									<th class="border-bottom-0">Rekening Tujuan</th>
									<th class="border-bottom-0">Barang</th>
									<th class="border-bottom-0">Qty</th>
									<th class="border-bottom-0">Jumlah</th>
                  <th class="border-bottom-0">Admin</th>
									<th class="border-bottom-0">Keterangan</th>
									<th class="border-bottom-0">Tanggal</th>
									<th class="border-bottom-0">Dibuat Oleh</th>
                  {% if request.user.role == 'developer' %}
									  <th class="border-bottom-0">Action</th>
                  {% endif %}
								</tr>
							</thead>
							<tbody>
              {% if filtered %}
                  {% for trx in transaksi %}
                  <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{ trx.jenis.nama }}</td>
                      <td>{{ trx.rekening_sumber.nama_rek|default:"-" }}</td>
                      <td>{{ trx.rekening_tujuan.nama_rek }}</td>
                      <td>{{ trx.barang.nama|default:"-" }}</td>
                      <td>{{ trx.qty }}</td>
                      <td>{{ trx.jumlah|intcomma }}</td>
                      <td>{{ trx.tax|intcomma|default:"-" }}</td>
                      <td>{{ trx.keterangan }}</td>
                      <td>{{ trx.created_at|date:"d M Y H:i" }}</td>
                      <td>{{ trx.dibuat_oleh.full_name }}</td>
                      {% if request.user.role == 'developer' %}
                      <td>
                          {% comment %} <a class="btn btn-primary btn-sm rounded-11 me-2"
                            data-bs-target="#modalEditTransaksi{{ trx.transaksi_id }}"
                            data-bs-toggle="modal" title="Edit">
                            <i class="fa fa-edit"></i>
                          </a> {% endcomment %}
                          <a class="btn btn-danger btn-sm rounded-11"
                            href=""
                            data-bs-toggle="tooltip" title="Delete"
                            data-message="Apakah Anda yakin ingin menghapus transaksi ini?">
                            <i class="fa fa-trash"></i>
                          </a>
                          
                            <a class="btn btn-danger btn-sm rounded-11 delete-link"
                                  href="#"
                                  data-url="{% url 'app:hapus_transaksi' id_transaksi=trx.transaksi_id %}"
                                  data-bs-toggle="tooltip"
                                  data-bs-original-title="Delete">
                                  <i>
                                    <svg class="table-delete" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="16">
                                      <path d="M0 0h24v24H0V0z" fill="none"/>
                                      <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4h-3.5z"/>
                                    </svg>
                                  </i>
                                  </a>
                          
                      </td>
                      {% endif %}
                  </tr>
                  {% empty %}
                  <tr>
                      <td colspan="11" class="text-center">Tidak ada transaksi pada filter ini</td>
                  </tr>
                  {% endfor %}
              {% else %}
                  <tr>
                      <td colspan="11" class="text-center text-muted">Silakan pilih filter untuk melihat transaksi</td>
                  </tr>
              {% endif %}
          </tbody>

						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="modalTambahTransaksi" tabindex="-1" aria-labelledby="modalTambahTransaksiLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTambahTransaksiLabel">Tambah Transaksi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{% url 'app:tambah_transaksi' %}" method="post">
          {% csrf_token %}

          <!-- Jenis Transaksi -->
          <div class="mb-3">
            <label for="jenis" class="form-label">Jenis Transaksi</label>
            <select name="jenis" id="jenis" class="form-control" required onchange="toggleJenis()">
              <option value="" disabled selected>-- Pilih Jenis --</option>
              {% for jns in jenis %}
              <option value="{{ jns.jenis_id }}" data-kategori="{{ jns.kategori }}">{{ jns.nama }} </option>
              {% endfor %}
            </select>
          </div>

          <!-- Rekening Sumber (hanya untuk bank) -->
          <div class="mb-3" id="field_rek_sumber" style="display:none;">
            <label for="rekening_sumber" class="form-label">Rekening Sumber</label>
            <select name="rekening_sumber" id="rekening_sumber" class="form-control"  onchange="filterRekeningTujuan()">
              <option value="" disabled selected>-- Pilih Rekening --</option>
              {% for rek in rekening %}
              <option value="{{ rek.rek_id }}">{{ rek.nama_rek }} (Saldo: {{ rek.saldo|intcomma }})</option>
              {% endfor %}
            </select>
          </div>

          <!-- Rekening Tujuan -->
          <div class="mb-3">
            <label for="rekening_tujuan" class="form-label">Rekening Tujuan</label>
            <select name="rekening_tujuan" id="rekening_tujuan" class="form-control" required>
              <option value="" disabled selected>-- Pilih Rekening --</option>
              {% for rek in rekening %}
              <option value="{{ rek.rek_id }}">{{ rek.nama_rek }} (Saldo: {{ rek.saldo|intcomma }})</option>
              {% endfor %}
            </select>
          </div>

          <!-- Jumlah (hanya untuk bank) -->
         <div class="mb-3" id="field_jumlah" style="display:none;">
          <label for="jumlah_display" class="form-label">Jumlah</label>
          <!-- Input tampilan (user lihat ini) -->
          <input type="text" id="jumlah_display" class="form-control" placeholder="Masukkan jumlah transfer" oninput="formatJumlah()">
          <!-- Input asli (hidden, untuk dikirim ke server) -->
          <input type="hidden" name="jumlah" id="jumlah">
        </div>

        <div class="mb-3" id="field_rek_tax" style="display:none;">
          <label for="rekening_tax" class="form-label">Rekening Admin (Opsional)</label>
          <select name="rekening_tax" id="rekening_tax" class="form-control">
            <option value="" selected>-- Gunakan rekening tujuan --</option>
            {% for rek in rekening %}
            <option value="{{ rek.rek_id }}">{{ rek.nama_rek }} (Saldo: {{ rek.saldo|intcomma }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3" id="field_tax" style="display:none;">
          <label for="tax_display" class="form-label">Admin</label>
          <!-- Input tampilan (user lihat ini) -->
          <input type="text" id="tax_display" class="form-control" placeholder="Masukkan jumlah admin" oninput="formatTax()">
          <!-- Input asli (hidden, untuk dikirim ke server) -->
          <input type="hidden" name="tax" id="tax">
        </div>

          <!-- Barang & Qty (hanya untuk barang) -->
          <div class="mb-3" id="field_barang" style="display:none;">
            <label for="barang" class="form-label">Barang</label>
            <select name="barang" id="barang" class="form-control">
              <option value="" disabled selected>-- Pilih Barang --</option>
              {% for b in barang %}
              <option value="{{ b.barang_id }}">{{ b.nama }} (Stok: {{ b.stok }}, Harga: {{ b.harga|intcomma }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3" id="field_qty" style="display:none;">
            <label for="qty" class="form-label">Jumlah Barang</label>
            <input type="number" name="qty" id="qty" class="form-control" min="1" placeholder="Masukkan jumlah barang">
          </div>

          <!-- Keterangan -->
          <div class="mb-3">
            <label for="keterangan" class="form-label">Keterangan</label>
            <textarea name="keterangan" id="keterangan" class="form-control" rows="3" placeholder="Opsional"></textarea>
          </div>

          <input type="hidden" name="dibuat_oleh" value="{{ request.user.user_id }}">

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function toggleJenis() {
  const select = document.getElementById("jenis");
  const kategori = select.options[select.selectedIndex].getAttribute("data-kategori");

  // reset semua dulu
  document.getElementById("field_rek_sumber").style.display = "none";
  document.getElementById("field_jumlah").style.display = "none";
  document.getElementById("field_barang").style.display = "none";
  document.getElementById("field_qty").style.display = "none";
  document.getElementById("field_rek_tax").style.display = "none";
  document.getElementById("field_tax").style.display = "none";

  // tampilkan sesuai kategori
  if (kategori === "KEUANGAN") {
    document.getElementById("field_rek_sumber").style.display = "block";
    document.getElementById("field_jumlah").style.display = "block";
    document.getElementById("field_tax").style.display = "block";
    document.getElementById("field_rek_tax").style.display = "block";
  } else if (kategori === "BARANG") {
    document.getElementById("field_barang").style.display = "block";
    document.getElementById("field_qty").style.display = "block";
  }
}

function filterRekeningTujuan() {
  const sumber = document.getElementById("rekening_sumber").value;
  const tujuan = document.getElementById("rekening_tujuan");

  for (let option of tujuan.options) {
    if (option.value === sumber && sumber !== "") {
      option.style.display = "none"; // sembunyikan rekening yg dipilih
    } else {
      option.style.display = "block"; // tampilkan lainnya
    }
  }

  // reset kalau tujuan = sumber
  if (tujuan.value === sumber) {
    tujuan.value = "";
  }
}

function formatJumlah() {
  let displayInput = document.getElementById("jumlah_display");
  let hiddenInput = document.getElementById("jumlah");

  // Hilangkan semua karakter non-angka
  let value = displayInput.value.replace(/[^0-9]/g, "");

  if (value === "") {
    hiddenInput.value = "";
    displayInput.value = "";
    return;
  }

  // Simpan angka asli ke input hidden
  hiddenInput.value = value;

  // Format ribuan (pakai titik, contoh: 1000000 -> 1.000.000)
  displayInput.value = new Intl.NumberFormat("id-ID").format(value);
}
</script>

<script>
function formatTax() {
    let display = document.getElementById("tax_display");
    let hidden = document.getElementById("tax");

    // Ambil hanya angka
    let value = display.value.replace(/\D/g, "");

    // Simpan ke hidden input (angka murni)
    hidden.value = value;

    // Format dengan titik pemisah ribuan
    display.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
</script>

{% endblock %}
