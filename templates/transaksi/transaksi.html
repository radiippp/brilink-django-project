{% extends "base/base.html" %}
{% load static %}
{% load humanize %}

{% block title %} Transaksi {% endblock %}

{% block main %}
<div class="side-app">
	<div class="page-header">
		<div>
			<h1 class="page-title">Daftar Transaksi</h1>
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="#">Transaksi</a></li>
				<li class="breadcrumb-item active" aria-current="page">Daftar Transaksi</li>
			</ol>
		</div>
	</div>

	<div class="row row-sm">
		<div class="col-lg-12">
			<div class="card">
				<div class="card-header">
					<h3 class="card-title">Daftar Transaksi</h3>
					<div class="ms-auto pageheader-btn">
						<a href="#" data-bs-target="#modalTambahTransaksi" data-bs-toggle="modal" class="btn btn-success">Tambah Transaksi</a>
					</div>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-bordered text-nowrap border-bottom w-100" id="responsive-datatable">
							<thead>
								<tr>
									<th class="border-bottom-0">No</th>
									<th class="border-bottom-0">Jenis</th>
									<th class="border-bottom-0">Rekening Sumber</th>
									<th class="border-bottom-0">Rekening Tujuan</th>
									<th class="border-bottom-0">Barang</th>
									<th class="border-bottom-0">Qty</th>
									<th class="border-bottom-0">Jumlah</th>
									<th class="border-bottom-0">Keterangan</th>
									<th class="border-bottom-0">Tanggal</th>
									<th class="border-bottom-0">Dibuat Oleh</th>
									<th class="border-bottom-0">Action</th>
								</tr>
							</thead>
							<tbody>
								{% for trx in transaksi %}
								<tr>
									<td>{{ forloop.counter }}</td>
									<td>{{ trx.get_jenis_display }}</td>
									<td>{{ trx.rekening_sumber.nama_rek|default:"-" }}</td>
									<td>{{ trx.rekening_tujuan.nama_rek }}</td>
									<td>{{ trx.barang.nama|default:"-" }}</td>
									<td>{{ trx.qty }}</td>
									<td>{{ trx.jumlah|intcomma }}</td>
									<td>{{ trx.keterangan }}</td>
									<td>{{ trx.created_at|date:"d M Y H:i" }}</td>
									<td>{{ trx.dibuat_oleh.full_name }}</td>
									<td>
										<a class="btn btn-primary btn-sm rounded-11 me-2"
											data-bs-target="#modalEditTransaksi{{ trx.transaksi_id }}"
											data-bs-toggle="modal" title="Edit">
											<i class="fa fa-edit"></i>
										</a>
										<a class="btn btn-danger btn-sm rounded-11"
											href="{% url 'app:hapus_transaksi' id_transaksi=trx.transaksi_id %}"
											data-bs-toggle="tooltip" title="Delete"
											data-message="Apakah Anda yakin ingin menghapus transaksi ini?">
											<i class="fa fa-trash"></i>
										</a>
									</td>
								</tr>
								{% empty %}
								<tr>
									<td colspan="11" class="text-center">Belum ada transaksi</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="modalTambahTransaksi" tabindex="-1" aria-labelledby="modalTambahTransaksiLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTambahTransaksiLabel">Tambah Transaksi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{% url 'app:tambah_transaksi' %}" method="post">
          {% csrf_token %}

          <!-- Jenis Transaksi -->
          <div class="mb-3">
            <label for="jenis" class="form-label">Jenis Transaksi</label>
            <select name="jenis" id="jenis" class="form-control" required onchange="toggleJenis()">
              <option value="" disabled selected>-- Pilih Jenis --</option>
              <option value="bank">Bank</option>
              <option value="barang">Transaksi Barang</option>
            </select>
          </div>

          <!-- Rekening Sumber (hanya untuk bank) -->
          <div class="mb-3" id="field_rek_sumber" style="display:none;">
            <label for="rekening_sumber" class="form-label">Rekening Sumber</label>
            <select name="rekening_sumber" id="rekening_sumber" class="form-control">
              <option value="" disabled selected>-- Pilih Rekening --</option>
              {% for rek in rekening %}
              <option value="{{ rek.rek_id }}">{{ rek.nama_rek }} (Saldo: {{ rek.saldo|intcomma }})</option>
              {% endfor %}
            </select>
          </div>

          <!-- Rekening Tujuan -->
          <div class="mb-3">
            <label for="rekening_tujuan" class="form-label">Rekening Tujuan</label>
            <select name="rekening_tujuan" id="rekening_tujuan" class="form-control" required>
              <option value="" disabled selected>-- Pilih Rekening --</option>
              {% for rek in rekening %}
              <option value="{{ rek.rek_id }}">{{ rek.nama_rek }} (Saldo: {{ rek.saldo|intcomma }})</option>
              {% endfor %}
            </select>
          </div>

          <!-- Jumlah (hanya untuk bank) -->
          <div class="mb-3" id="field_jumlah" style="display:none;">
            <label for="jumlah" class="form-label">Jumlah</label>
            <input type="number" step="0.01" min="0" name="jumlah" id="jumlah" class="form-control" placeholder="Masukkan jumlah transfer">
          </div>

          <!-- Barang & Qty (hanya untuk barang) -->
          <div class="mb-3" id="field_barang" style="display:none;">
            <label for="barang" class="form-label">Barang</label>
            <select name="barang" id="barang" class="form-control">
              <option value="" disabled selected>-- Pilih Barang --</option>
              {% for b in barang %}
              <option value="{{ b.barang_id }}">{{ b.nama }} (Stok: {{ b.stok }}, Harga: {{ b.harga|intcomma }})</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3" id="field_qty" style="display:none;">
            <label for="qty" class="form-label">Jumlah Barang</label>
            <input type="number" name="qty" id="qty" class="form-control" min="1" placeholder="Masukkan jumlah barang">
          </div>

          <!-- Keterangan -->
          <div class="mb-3">
            <label for="keterangan" class="form-label">Keterangan</label>
            <textarea name="keterangan" id="keterangan" class="form-control" rows="3" placeholder="Opsional"></textarea>
          </div>

          <input type="hidden" name="dibuat_oleh" value="{{ request.user.user_id }}">

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function toggleJenis() {
  const jenis = document.getElementById("jenis").value;
  document.getElementById("field_rek_sumber").style.display = (jenis === "bank") ? "block" : "none";
  document.getElementById("field_jumlah").style.display = (jenis === "bank") ? "block" : "none";
  document.getElementById("field_barang").style.display = (jenis === "barang") ? "block" : "none";
  document.getElementById("field_qty").style.display = (jenis === "barang") ? "block" : "none";
}
</script>

{% endblock %}
